# use anchors from another file to avoid repetition
!exclude _: !include rf/build-s01-p02.yaml
!exclude _: !include rf/build-s01-intel.yaml
spack:
  # CUSTOM MODULES
  # these modifications blacklist the system compiler to make Core packages
  # this streamlines the lmod tree that we expose to the users
  view: false
  config:
    module_roots: 
      lmod: ./lmod
  modules: *modules
  # EXTERNAL packages
  # note that we are using compilers built by spack above and for now neglecting to mark them external
  packages:
    slurm:
      buildable: false
      externals:
      - prefix: /cm/shared/apps/slurm/current
        spec: slurm@19.05.7
  # beware that we use lists of lists
  specs: !flatten
  - - - *ips
  - - - *gcc10
  - *gcc-all
  # define the oneapi compiler and use compiler_alias to set the modulepath
  - - - &intel !compiler_alias
          spec: *ips
          spec_base: *ips-base
          compiler: oneapi@2021.1
  # group all Intel-compiled applications below
  - &intel-compiled
    # compiled (non-MPI) applications built on Intel
    - !compiled
      compiler: &intel oneapi@2021.1
      specs: *gcc-specs
    # intel Python
    - - &py399i !cat [!cat [python@3.9.9, *pybase], !spec {compiler: *intel}]
    # packages compiled for python 3.9.9
    - !loop_depends
      base: *py399i
      specs: *py-mods-compiled
    # define the Intel MPI
    # we cannot detect intel MPI from inside the intel-parallel-studio even though it exists
    #   so we make our own intel MPI here
    - - !cat
        - &intel-mpi intel-oneapi-mpi@2021.5.1
        - !spec {compiler: *intel}
  # group all Intel and Intel MPI applications below
  - &intel-mpi-deps
    # packages compiled for python 3.9.9 with intel MPI
    - !loop_depends
      base: !cat
        - *py399i
        - !spec {depends: *intel-mpi}
      specs: 
      - !cat
        - py-numpy
        - !spec {depends: *intel-oneapi-mkl-base}
      - py-scipy
